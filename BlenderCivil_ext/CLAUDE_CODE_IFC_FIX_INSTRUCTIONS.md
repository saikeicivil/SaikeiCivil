# Saikei Civil IFC Generation Fix Instructions

## For Claude Code - Repository Path
```
C:\Users\amish\OneDrive\OneDrive Documents\GitHub\Saikei Civil\saikei
```

---

## Executive Summary

Saikei Civil generates IFC files that work in Blender but **fail to display in external viewers** like Solibri, FreeCAD, and BIMcollab. The IFC file contains valid alignment data and geometry, but is missing required structural elements that external viewers need to locate and render the content.

**The geometry exists - it's just not connected properly.**

---

## Problems Identified (from real file analysis)

Analyzing `SH-21_STA.ifc` generated by Saikei Civil revealed:

| Issue | Current State | Required State |
|-------|---------------|----------------|
| **Units** | `project.UnitsInContext = None` | Must have IfcUnitAssignment |
| **RepresentationContexts** | `project.RepresentationContexts = None` | Must link to IfcGeometricRepresentationContext |
| **Spatial Containment** | No IfcRelContainedInSpatialStructure | Alignment must be contained in Road/Site |
| **ObjectPlacement** | `alignment.ObjectPlacement = None` | Must have IfcLocalPlacement |
| **Representation Link** | `alignment.Representation = None` | Must link to IfcProductDefinitionShape |

### What's Working (don't break these)
- ✅ IfcAlignment entity created correctly
- ✅ IfcAlignmentHorizontal with segments
- ✅ IfcAlignmentVertical with segments  
- ✅ IfcRelNests relationships
- ✅ IfcGradientCurve geometry
- ✅ IfcProductDefinitionShape exists
- ✅ IFC4X3_ADD2 schema

---

## Search Patterns for Claude Code

Search the codebase for these patterns to find where IFC files are created:

```python
# Search for IFC file creation
ifcopenshell.file(
createIfcProject
createIfcSite
createIfcRoad
createIfcAlignment

# Search for where files are written
ifc_file.write(
.write(filepath)

# Search for existing relationship creation
createIfcRelAggregates
createIfcRelNests
createIfcRelContainedInSpatialStructure  # This one is likely MISSING

# Search for unit/context creation
createIfcUnitAssignment  # Likely MISSING
createIfcSIUnit  # Likely MISSING
createIfcGeometricRepresentationContext
RepresentationContexts
UnitsInContext
```

---

## Required Code Changes

### Fix 1: Add Units to Project

**Find:** Where `IfcProject` is created  
**Add:** Unit assignment creation and linking

```python
# AFTER creating project, ADD THIS:

# Create SI units
length_unit = ifc_file.createIfcSIUnit(
    Dimensions=None,
    UnitType='LENGTHUNIT',
    Prefix=None,
    Name='METRE'
)
area_unit = ifc_file.createIfcSIUnit(
    Dimensions=None,
    UnitType='AREAUNIT',
    Prefix=None,
    Name='SQUARE_METRE'
)
volume_unit = ifc_file.createIfcSIUnit(
    Dimensions=None,
    UnitType='VOLUMEUNIT',
    Prefix=None,
    Name='CUBIC_METRE'
)
plane_angle_unit = ifc_file.createIfcSIUnit(
    Dimensions=None,
    UnitType='PLANEANGLEUNIT',
    Prefix=None,
    Name='RADIAN'
)

# Create and link unit assignment
unit_assignment = ifc_file.createIfcUnitAssignment(
    Units=[length_unit, area_unit, volume_unit, plane_angle_unit]
)
project.UnitsInContext = unit_assignment
```

---

### Fix 2: Link RepresentationContext to Project

**Find:** Where `IfcGeometricRepresentationContext` is created  
**Fix:** Ensure it's linked to project's `RepresentationContexts`

```python
# Create representation context (may already exist)
origin = ifc_file.createIfcCartesianPoint((0., 0., 0.))
z_axis = ifc_file.createIfcDirection((0., 0., 1.))
x_axis = ifc_file.createIfcDirection((1., 0., 0.))
world_placement = ifc_file.createIfcAxis2Placement3D(
    Location=origin,
    Axis=z_axis,
    RefDirection=x_axis
)

context_3d = ifc_file.createIfcGeometricRepresentationContext(
    ContextIdentifier=None,
    ContextType='Model',
    CoordinateSpaceDimension=3,
    Precision=1e-5,
    WorldCoordinateSystem=world_placement,
    TrueNorth=None
)

# CRITICAL: Link to project
project.RepresentationContexts = [context_3d]
```

---

### Fix 3: Add Spatial Containment for Alignment

**Find:** Where IfcAlignment is created and related to spatial structure  
**Problem:** Only IfcRelAggregates exists (Project→Site→Road), but alignment isn't CONTAINED  
**Add:** IfcRelContainedInSpatialStructure

```python
# AFTER creating alignment and road/site, ADD THIS:

# Contain alignment in road (or site if no road)
ifc_file.createIfcRelContainedInSpatialStructure(
    GlobalId=ifcopenshell.guid.new(),
    OwnerHistory=None,  # or owner_history if you have one
    Name='RoadContainsAlignments',
    Description='Alignments contained in road facility',
    RelatedElements=[alignment],  # List of alignments
    RelatingStructure=road  # or site
)
```

**Note:** This is DIFFERENT from IfcRelAggregates. You need BOTH:
- `IfcRelAggregates`: Project → Site → Road (spatial decomposition)
- `IfcRelContainedInSpatialStructure`: Road contains Alignment (spatial containment)

---

### Fix 4: Add ObjectPlacement to Alignment

**Find:** Where IfcAlignment is created  
**Problem:** `ObjectPlacement` parameter is `None` or `$`  
**Fix:** Create and assign IfcLocalPlacement

```python
# Create placement for alignment
origin = ifc_file.createIfcCartesianPoint((0., 0., 0.))
axis_placement = ifc_file.createIfcAxis2Placement3D(
    Location=origin,
    Axis=None,  # Defaults to Z-up
    RefDirection=None  # Defaults to X
)
local_placement = ifc_file.createIfcLocalPlacement(
    PlacementRelTo=None,  # or site/road placement for relative positioning
    RelativePlacement=axis_placement
)

# When creating alignment, include placement:
alignment = ifc_file.createIfcAlignment(
    GlobalId=ifcopenshell.guid.new(),
    OwnerHistory=None,
    Name=alignment_name,
    Description=None,
    ObjectType=None,
    ObjectPlacement=local_placement,  # <-- ADD THIS
    Representation=None,  # Will be set later
    PredefinedType='USERDEFINED'
)
```

---

### Fix 5: Link Representation to Alignment

**Find:** Where IfcProductDefinitionShape / IfcShapeRepresentation is created  
**Problem:** Shape is created but never linked to alignment.Representation  
**Fix:** Assign the ProductDefinitionShape to alignment

```python
# After creating the shape representation and product definition shape:
shape_rep = ifc_file.createIfcShapeRepresentation(
    ContextOfItems=context_3d,
    RepresentationIdentifier='Axis',
    RepresentationType='Curve3D',
    Items=[gradient_curve]  # or composite_curve
)

product_shape = ifc_file.createIfcProductDefinitionShape(
    Name=None,
    Description=None,
    Representations=[shape_rep]
)

# CRITICAL: Link to alignment
alignment.Representation = product_shape
```

---

## Complete IFC Structure Required

```
IfcProject
├── UnitsInContext → IfcUnitAssignment
│   └── [IfcSIUnit (METRE), IfcSIUnit (SQUARE_METRE), ...]
├── RepresentationContexts → [IfcGeometricRepresentationContext]
└── IfcRelAggregates
    └── IfcSite
        └── IfcRelAggregates
            └── IfcRoad
                └── IfcRelContainedInSpatialStructure  ← MISSING
                    └── IfcAlignment
                        ├── ObjectPlacement → IfcLocalPlacement  ← MISSING
                        ├── Representation → IfcProductDefinitionShape  ← MISSING
                        └── IfcRelNests
                            ├── IfcAlignmentHorizontal
                            │   └── IfcRelNests → [IfcAlignmentSegment...]
                            └── IfcAlignmentVertical
                                ├── Representation → IfcProductDefinitionShape ✓
                                └── IfcRelNests → [IfcAlignmentSegment...]
```

---

## Validation Code

Add this validation function to verify IFC files before saving:

```python
def validate_ifc_for_external_viewers(ifc_file) -> list:
    """
    Validate IFC file will work in external viewers.
    Call before ifc_file.write() and fix any issues.
    """
    issues = []
    
    # Check project
    project = ifc_file.by_type("IfcProject")[0]
    if not project.UnitsInContext:
        issues.append("CRITICAL: Project missing UnitsInContext")
    if not project.RepresentationContexts:
        issues.append("CRITICAL: Project missing RepresentationContexts")
    
    # Check spatial containment
    containments = ifc_file.by_type("IfcRelContainedInSpatialStructure")
    contained_ids = set()
    for rel in containments:
        if rel.RelatedElements:
            for elem in rel.RelatedElements:
                contained_ids.add(elem.id())
    
    # Check alignments
    for alignment in ifc_file.by_type("IfcAlignment"):
        name = alignment.Name or f"#{alignment.id()}"
        if alignment.id() not in contained_ids:
            issues.append(f"CRITICAL: {name} not in spatial structure (missing IfcRelContainedInSpatialStructure)")
        if not alignment.ObjectPlacement:
            issues.append(f"CRITICAL: {name} missing ObjectPlacement")
        if not alignment.Representation:
            issues.append(f"WARNING: {name} missing Representation (geometry won't display)")
    
    return issues
```

---

## Files to Likely Modify

Based on typical Saikei Civil structure, search in:

1. **Core IFC creation** - Look for files with names like:
   - `native_ifc_*.py`
   - `ifc_*.py`
   - `alignment*.py`

2. **Operators that save files** - Look for:
   - `BC_OT_save_ifc` or similar operator classes
   - Functions with `write` or `save` or `export` in name

3. **Manager/Store classes** - Look for:
   - `NativeIfcManager`
   - `IfcStore`
   - Classes that hold the `ifc_file` object

---

## Testing After Fix

After implementing fixes, test by:

1. Create a simple alignment in Saikei Civil
2. Save to IFC
3. Open in Solibri (or FreeCAD, BIMcollab ZOOM)
4. Verify:
   - File opens without errors
   - Alignment appears in model tree under Road/Site
   - 3D geometry displays in viewport
   - Properties are readable

---

## Quick Reference: IFC Entity Creation Order

```python
# 1. Create file
ifc_file = ifcopenshell.file(schema='IFC4X3_ADD2')

# 2. Create units FIRST
units = create_units(ifc_file)

# 3. Create representation context
context = create_context(ifc_file)

# 4. Create project WITH units and context
project = ifc_file.createIfcProject(..., RepresentationContexts=[context], UnitsInContext=units)

# 5. Create spatial structure
site = create_site(ifc_file)
road = create_road(ifc_file)
# Link: Project → Site → Road via IfcRelAggregates

# 6. Create placement
placement = create_local_placement(ifc_file)

# 7. Create alignment WITH placement
alignment = ifc_file.createIfcAlignment(..., ObjectPlacement=placement, ...)

# 8. Create alignment components (horizontal, vertical, segments)
# ...

# 9. Create geometry (curves, gradient curves)
# ...

# 10. Create representation and link to alignment
shape = create_product_definition_shape(ifc_file, geometry)
alignment.Representation = shape

# 11. Create spatial CONTAINMENT (not just aggregation!)
ifc_file.createIfcRelContainedInSpatialStructure(..., RelatedElements=[alignment], RelatingStructure=road)

# 12. Validate before saving
issues = validate_ifc_for_external_viewers(ifc_file)
if issues:
    print("WARNING:", issues)

# 13. Write file
ifc_file.write(filepath)
```

---

## Summary of Required Additions

| What to Add | Where to Add It | IFC Entity |
|-------------|-----------------|------------|
| Unit definitions | After creating ifc_file, before project | IfcSIUnit, IfcUnitAssignment |
| Link units to project | When creating project | `project.UnitsInContext = units` |
| Link context to project | When creating project | `project.RepresentationContexts = [context]` |
| Spatial containment | After creating alignment and road | IfcRelContainedInSpatialStructure |
| Object placement | When creating alignment | IfcLocalPlacement |
| Link representation | After creating geometry | `alignment.Representation = shape` |

**Priority Order:** Fix units and context first (affects entire file), then containment and placement (affects visibility), then representation linking (affects geometry display).
